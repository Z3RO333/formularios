<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Painel administrativo de pedidos">
    <title>Painel | Sistema de Pedidos</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://alcdn.msauth.net/browser/2.30.0/js/msal-browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-MC1S0VqNx8Y2L6kJOS2kYUyi6FS9qJzD/MLpDI5v46QF5/Cr3NoGoQgtuUic8/BxEGoA3vNpd1KJ45p6cH0dpQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="config.js"></script>
    <script src="data-layer.js"></script>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --bg-body: radial-gradient(circle at 20% 20%, rgba(59,130,246,0.2), transparent 25%),
                        radial-gradient(circle at 80% 0%, rgba(14,165,233,0.18), transparent 25%),
                        #0b1221;
            --text: #e2e8f0;
            --muted: #94a3b8;
            --border: #1f2937;
            --shadow: 0 20px 60px rgba(0,0,0,0.35);
            --radius: 14px;
        }
        * { box-sizing: border-box; }
        body { margin:0; font-family:'Inter',system-ui,-apple-system,sans-serif; background:var(--bg-body); color:var(--text); min-height:100vh; padding:40px 16px 80px; position:relative; overflow-x:hidden; }
        body::before { content:''; position:fixed; inset:0; background:radial-gradient(1px 1px at 20% 30%, rgba(255,255,255,0.6), transparent),radial-gradient(2px 2px at 70% 10%, rgba(255,255,255,0.4), transparent),radial-gradient(2px 2px at 50% 80%, rgba(255,255,255,0.35), transparent),radial-gradient(1px 1px at 90% 50%, rgba(255,255,255,0.45), transparent); opacity:0.5; pointer-events:none; animation:stars 60s linear infinite; }
        @keyframes stars { from{transform:translateX(0);} to{transform:translateX(80px);} }
        .page { max-width: 1200px; margin:0 auto; position:relative; z-index:1; }
        .hero { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:16px; }
        .hero h1 { margin:0; font-size: clamp(24px,3vw,32px); }
        .hero p { margin:6px 0 0; color:var(--muted); }
        .badge { display:inline-flex; align-items:center; gap:6px; background:rgba(59,130,246,0.15); color:#bfdbfe; padding:6px 10px; border-radius:999px; font-weight:600; font-size:13px; }
        .card { background:rgba(15,23,42,0.92); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); margin-bottom:16px; }
        .card-header { padding:18px 20px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
        .card-body { padding:18px 20px; }
        .filters { display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
        label { display:block; margin-bottom:6px; font-weight:600; }
        input, select { width:100%; padding:10px; border-radius:10px; border:1px solid var(--border); background:#0b1221; color:var(--text); }
        input:focus, select:focus { outline:2px solid rgba(59,130,246,0.35); border-color:var(--primary); }
        .muted { color:var(--muted); font-size:13px; }
        .table-wrapper { border:1px solid var(--border); border-radius:12px; overflow:hidden; }
        table { width:100%; border-collapse:collapse; background:#0b1221; }
        th, td { padding:10px; border-bottom:1px solid var(--border); text-align:left; font-size:14px; }
        th { background:rgba(255,255,255,0.03); }
        tr:hover td { background:rgba(255,255,255,0.02); cursor:pointer; }
        .status { display:inline-flex; padding:4px 8px; border-radius:8px; font-size:12px; text-transform:uppercase; font-weight:700; }
        .status-pendente { background:rgba(234,179,8,0.18); color:#fef08a; }
        .status-aprovado { background:rgba(34,197,94,0.18); color:#bbf7d0; }
        .status-recusado { background:rgba(239,68,68,0.18); color:#fecdd3; }
        .status-cotacao { background:rgba(59,130,246,0.15); color:#bfdbfe; }
        .status-sap { background:rgba(94,234,212,0.18); color:#a5f3fc; }
        .btn { border:none; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; display:inline-flex; align-items:center; gap:8px; color:#fff; }
        .btn-primary { background:linear-gradient(135deg, var(--primary), var(--primary-dark)); box-shadow:0 10px 30px rgba(59,130,246,0.35); }
        .btn-secondary { background:#1f2937; color:#e2e8f0; }
        .btn-success { background:linear-gradient(135deg, #16a34a, #15803d); }
        .btn-danger { background:linear-gradient(135deg, #ef4444, #b91c1c); }
        .actions { display:flex; gap:10px; flex-wrap:wrap; }
        .alert { display:none; padding:12px; border-radius:10px; margin-bottom:12px; }
        .alert.show { display:block; }
        .alert-error { background:rgba(239,68,68,0.15); border:1px solid rgba(239,68,68,0.3); color:#fecdd3; }
        .alert-success { background:rgba(34,197,94,0.15); border:1px solid rgba(34,197,94,0.3); color:#bbf7d0; }
        .modal { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; padding:20px; z-index:10; }
        .modal.show { display:flex; }
        .modal-content { background:#0b1221; border:1px solid var(--border); border-radius:14px; max-width:900px; width:100%; max-height:90vh; overflow:auto; box-shadow:var(--shadow); }
        .modal-header { padding:16px 18px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
        .modal-body { padding:18px; display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
        .modal-footer { padding:16px 18px; border-top:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap; }
        .timeline { border-left:2px solid var(--border); padding-left:12px; margin-top:8px; }
        .timeline-item { margin-bottom:10px; }
        .timeline-item strong { display:block; }
        @media (max-width:640px) { .actions { flex-direction:column; } .btn { width:100%; justify-content:center; } }
    </style>
</head>
<body>
<div class="page">
    <div class="hero">
        <div>
            <div class="badge">üîê Acesso Restrito</div>
            <h1>Painel de Controle</h1>
            <p>Gest√£o de pedidos, aprova√ß√£o/recusa, fornecedores e PDFs.</p>
        </div>
        <div class="actions">
            <button id="btnLogin" class="btn btn-secondary">Entrar com Microsoft</button>
            <a class="btn btn-secondary" href="index.html">‚Üê Voltar ao formul√°rio</a>
        </div>
    </div>

    <div id="alertPanel" class="alert"></div>

    <div class="card" id="cardSuspeitos" style="display:none;">
        <div class="card-header">
            <div>
                <strong>Fornecedores suspeitos de duplicidade</strong>
                <div class="muted">Baseado em similaridade de nomes; use "Mesclar" para unificar.</div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-wrapper">
                <table>
                    <thead><tr><th>Fornecedor A</th><th>Fornecedor B</th><th>Similaridade</th><th>A√ß√£o</th></tr></thead>
                    <tbody id="tbodySuspeitos"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card" id="cardFiltros" style="display:none;">
        <div class="card-header">
            <div>
                <strong>Filtros avan√ßados</strong>
                <div class="muted">Status, datas, √°rea, loja, fornecedor e texto livre.</div>
            </div>
            <div class="actions">
                <button class="btn btn-primary" id="btnPdfFornecedor">PDF por fornecedor</button>
                <button class="btn btn-primary" id="btnPdfLoja">PDF por loja/unidade</button>
            </div>
        </div>
        <div class="card-body">
            <div class="filters">
                <div>
                    <label>Status</label>
                    <select id="filtroStatus"><option value="">Todos</option></select>
                </div>
                <div>
                    <label>√Årea/Setor</label>
                    <select id="filtroArea"><option value="">Todas</option></select>
                </div>
                <div>
                    <label>Loja/Unidade</label>
                    <select id="filtroLoja"><option value="">Todas</option></select>
                </div>
                <div>
                    <label>Fornecedor</label>
                    <select id="filtroFornecedor"><option value="">Todos</option></select>
                </div>
                <div>
                    <label>Data inicial</label>
                    <input type="date" id="filtroDataInicial">
                </div>
                <div>
                    <label>Data final</label>
                    <input type="date" id="filtroDataFinal">
                </div>
                <div>
                    <label>Busca texto</label>
                    <input type="search" id="filtroBusca" placeholder="ID, descri√ß√£o, justificativa...">
                </div>
            </div>
        </div>
    </div>

    <div class="card" id="cardTabela" style="display:none;">
        <div class="card-header">
            <div>
                <strong>Pedidos</strong>
                <div class="muted">Clique em uma linha para ver detalhes e aprovar/recusar.</div>
            </div>
            <div class="muted" id="userInfo"></div>
        </div>
        <div class="card-body">
            <div class="table-wrapper">
                <table>
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Data</th>
                        <th>Solicitante</th>
                        <th>√Årea</th>
                        <th>Loja</th>
                        <th>Fornecedor</th>
                        <th>Status</th>
                    </tr>
                    </thead>
                    <tbody id="tbodyPedidos"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="modalDetalhe">
    <div class="modal-content">
        <div class="modal-header">
            <div>
                <h3 id="modalTitulo" style="margin:0;">Pedido</h3>
                <div class="muted" id="modalSubtitulo"></div>
            </div>
            <button class="btn btn-secondary" id="btnFecharModal">Fechar</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer">
            <div class="muted">Todas as a√ß√µes s√£o registradas em HistoricoStatus.</div>
            <div class="actions">
                <button class="btn btn-success" id="btnAprovar">‚úì Aprovar</button>
                <button class="btn btn-danger" id="btnRecusar">‚úï Recusar</button>
            </div>
        </div>
    </div>
</div>

<script>
    const AppState = { user: null, pedidos: [], filtros: {}, fornecedores: [], suspeitos: [], pedidoAtual: null };
    const msalInstance = new msal.PublicClientApplication({ auth: window.APP_CONFIG.azureAd });

    const UI = {
        alert(msg, type = 'success') {
            const el = document.getElementById('alertPanel');
            el.textContent = msg; el.className = `alert alert-${type} show`;
            setTimeout(() => el.classList.remove('show'), 4000);
        },
        statusBadge(status) {
            const map = { PENDENTE_APROVACAO:'status-pendente', APROVADO:'status-aprovado', RECUSADO:'status-recusado', EM_COTACAO:'status-cotacao', ENVIADO_SAP:'status-sap' };
            return `<span class="status ${map[status] || ''}">${status}</span>`;
        },
        renderTabela(pedidos) {
            const tbody = document.getElementById('tbodyPedidos');
            tbody.innerHTML = pedidos.map(p => `
                <tr data-id="${p.id}">
                    <td>${p.id}</td>
                    <td>${new Date(p.data_criacao).toLocaleDateString()}</td>
                    <td>${p.solicitante?.nome || ''}</td>
                    <td>${p.area_setor || ''}</td>
                    <td>${p.loja_unidade || ''}</td>
                    <td>${p.fornecedor_detectado || p.fornecedor_nome_digitado || '‚Äî'}</td>
                    <td>${UI.statusBadge(p.status)}</td>
                </tr>
            `).join('');
            tbody.querySelectorAll('tr').forEach(row => row.addEventListener('click', () => abrirDetalhe(row.dataset.id)));
        },
        renderSelect(id, options) {
            const select = document.getElementById(id);
            select.innerHTML = '<option value="">Todos</option>' + options.map(opt => `<option value="${opt.value || opt}">${opt.label || opt}</option>`).join('');
        },
        renderSuspeitos() {
            const card = document.getElementById('cardSuspeitos');
            const tbody = document.getElementById('tbodySuspeitos');
            if (!AppState.suspeitos.length) { card.style.display = 'none'; return; }
            card.style.display = 'block';
            tbody.innerHTML = AppState.suspeitos.map(s => `
                <tr>
                    <td>${s.a.nome_canonico}</td>
                    <td>${s.b.nome_canonico}</td>
                    <td>${(s.score*100).toFixed(1)}%</td>
                    <td><button class="btn btn-secondary" data-primary="${s.a.id_fornecedor}" data-secondary="${s.b.id_fornecedor}">Mesclar em ${s.a.nome_canonico}</button></td>
                </tr>
            `).join('');
            tbody.querySelectorAll('button').forEach(btn => btn.addEventListener('click', () => mesclar(btn.dataset.primary, btn.dataset.secondary)));
        },
        renderDetalhe(pedido) {
            document.getElementById('modalTitulo').textContent = `${pedido.id} ‚Äî ${pedido.status}`;
            document.getElementById('modalSubtitulo').textContent = `Criado em ${new Date(pedido.data_criacao).toLocaleString()} por ${pedido.solicitante?.nome || ''}`;
            const body = document.getElementById('modalBody');
            body.innerHTML = `
                <div><label>Solicitante</label><div>${pedido.solicitante?.nome} ‚Äî ${pedido.solicitante?.email}</div></div>
                <div><label>√Årea / Loja</label><div>${pedido.area_setor} ‚Ä¢ ${pedido.loja_unidade}</div></div>
                <div><label>Tipo / Prioridade</label><div>${pedido.tipo_pedido} ‚Ä¢ ${pedido.prioridade}</div></div>
                <div><label>Fornecedor detectado</label><div>${pedido.fornecedor_detectado || '‚Äî'} <span class="muted">(digitado: ${pedido.fornecedor_nome_digitado || '‚Äî'}${pedido.fornecedor_cnpj ? ` | CNPJ ${pedido.fornecedor_cnpj}` : ''})</span></div></div>
                <div><label>Descri√ß√£o</label><div>${pedido.descricao_detalhada}</div></div>
                <div><label>Justificativa</label><div>${pedido.justificativa}</div></div>
                <div style="grid-column: 1 / -1;"><label>Itens</label><div class="table-wrapper"><table><thead><tr><th>Material</th><th>Qtd</th><th>Un</th><th>Fornecedor (item)</th><th>Pre√ßo</th><th>Obs</th></tr></thead><tbody>${(pedido.itens||[]).map(i=>`<tr><td>${i.material}</td><td>${i.quantidade}</td><td>${i.unidade}</td><td>${i.fornecedor_sugerido||''}</td><td>${i.preco_unitario_estimado||''}</td><td>${i.observacao||''}</td></tr>`).join('')}</tbody></table></div></div>
                <div style="grid-column: 1 / -1;"><label>Anexos</label><div>${(pedido.anexos||[]).length ? pedido.anexos.map(a=>`<div>üìé ${a.nome} (${(a.tamanho/1024/1024).toFixed(2)} MB)</div>`).join('') : 'Nenhum'}</div></div>
                <div style="grid-column: 1 / -1;"><label>Hist√≥rico</label><div class="timeline">${(pedido.historicoStatus||[]).map(h=>`<div class="timeline-item"><strong>${h.status_antigo || '‚Äî'} ‚Üí ${h.status_novo}</strong><span class="muted">${new Date(h.data_hora).toLocaleString()} ‚Ä¢ ${h.usuario_responsavel || ''}</span>${h.observacao ? `<div>${h.observacao}</div>`:''}</div>`).join('')}</div></div>
            `;
        },
        toggleLoggedIn(state) {
            ['cardFiltros','cardTabela'].forEach(id => document.getElementById(id).style.display = state ? 'block' : 'none');
        }
    };

    async function ensureLogin() {
        const accounts = msalInstance.getAllAccounts();
        if (accounts.length) return accounts[0];
        const response = await msalInstance.loginPopup({ scopes: ['User.Read'] });
        return response.account;
    }

    function validarGestor(account) {
        const email = (account.username || '').toLowerCase();
        const dominio = email.split('@')[1];
        const autorizado = window.APP_CONFIG.gestoresAutorizados.map(e => e.toLowerCase()).includes(email) || window.APP_CONFIG.dominiosPermitidos.includes(dominio);
        if (!autorizado) throw new Error('Acesso negado: usu√°rio sem perfil gestor.');
        return true;
    }

    async function carregarFornecedores() {
        AppState.fornecedores = await window.FornecedorRepository.listAtivos();
        UI.renderSelect('filtroFornecedor', AppState.fornecedores.map(f => ({ value: f.id_fornecedor, label: f.nome_canonico })));
        AppState.suspeitos = await window.FornecedorService.suspeitos();
        UI.renderSuspeitos();
    }

    async function carregarPedidos() {
        const f = AppState.filtros;
        AppState.pedidos = await window.PedidoRepository.listar({ status: f.status, area: f.area, loja: f.loja, fornecedor: f.fornecedor, fornecedorId: f.fornecedor, busca: f.busca, dataInicial: f.dataInicial, dataFinal: f.dataFinal });
        UI.renderTabela(AppState.pedidos);
    }

    function aplicarFiltros() {
        AppState.filtros = {
            status: document.getElementById('filtroStatus').value,
            area: document.getElementById('filtroArea').value,
            loja: document.getElementById('filtroLoja').value,
            fornecedor: document.getElementById('filtroFornecedor').value,
            dataInicial: document.getElementById('filtroDataInicial').value,
            dataFinal: document.getElementById('filtroDataFinal').value,
            busca: document.getElementById('filtroBusca').value
        };
        carregarPedidos();
    }

    async function abrirDetalhe(id) {
        const pedido = AppState.pedidos.find(p => p.id === id);
        if (!pedido) return;
        AppState.pedidoAtual = pedido;
        UI.renderDetalhe(pedido);
        document.getElementById('modalDetalhe').classList.add('show');
    }
    const fecharModal = () => document.getElementById('modalDetalhe').classList.remove('show');

    async function aprovarPedido() {
        if (!AppState.pedidoAtual) return;
        const now = new Date().toISOString();
        const payload = {
            status: 'APROVADO',
            aprovado_por: { nome: AppState.user.name, email: AppState.user.username },
            data_aprovacao: now,
            historicoStatus: [...(AppState.pedidoAtual.historicoStatus || []), {
                status_antigo: AppState.pedidoAtual.status,
                status_novo: 'APROVADO',
                data_hora: now,
                usuario_responsavel: AppState.user.username,
                observacao: 'Aprovado no painel'
            }]
        };
        await window.PedidoRepository.atualizarStatus(AppState.pedidoAtual.id, payload, 'aprovar');
        await window.NotificacaoService.enviarEvento('status', { id: AppState.pedidoAtual.id, status: 'APROVADO' });
        UI.alert('Pedido aprovado.', 'success');
        fecharModal();
        carregarPedidos();
    }

    async function recusarPedido() {
        if (!AppState.pedidoAtual) return;
        const justificativa = prompt('Informe a justificativa da recusa:');
        if (!justificativa) return UI.alert('Justificativa √© obrigat√≥ria', 'error');
        const now = new Date().toISOString();
        const payload = {
            status: 'RECUSADO',
            recusado_por: { nome: AppState.user.name, email: AppState.user.username },
            data_recusa: now,
            justificativa_recusa: justificativa,
            historicoStatus: [...(AppState.pedidoAtual.historicoStatus || []), {
                status_antigo: AppState.pedidoAtual.status,
                status_novo: 'RECUSADO',
                data_hora: now,
                usuario_responsavel: AppState.user.username,
                observacao: justificativa
            }]
        };
        await window.PedidoRepository.atualizarStatus(AppState.pedidoAtual.id, payload, 'recusar');
        await window.NotificacaoService.enviarEvento('status', { id: AppState.pedidoAtual.id, status: 'RECUSADO' });
        UI.alert('Pedido recusado.', 'success');
        fecharModal();
        carregarPedidos();
    }

    const PdfService = {
        gerar(relatorio, pedidos) {
            if (!pedidos.length) return UI.alert('Nenhum pedido para gerar PDF', 'error');
            const { jsPDF } = window.jspdf; const doc = new jsPDF(); let y = 14;
            doc.text(`Relat√≥rio por ${relatorio}`, 14, y); y += 8;
            pedidos.forEach((p, idx) => {
                if (y > 270) { doc.addPage(); y = 20; }
                doc.text(`${idx + 1}. ${p.id} ‚Ä¢ ${p.status}`, 14, y); y += 6;
                doc.text(`Fornecedor: ${p.fornecedor_detectado || p.fornecedor_nome_digitado || '‚Äî'} | Loja: ${p.loja_unidade || '‚Äî'} | Data: ${new Date(p.data_criacao).toLocaleDateString()}`, 14, y); y += 6;
                doc.text(`Descri√ß√£o: ${(p.descricao_detalhada || '').slice(0, 80)}`, 14, y); y += 6;
                doc.text(`Itens: ${(p.itens || []).map(i => `${i.material} (${i.quantidade}${i.unidade})`).join('; ')}`, 14, y); y += 8;
            });
            doc.save(`relatorio-${relatorio.toLowerCase()}-${Date.now()}.pdf`);
        }
    };

    async function mesclar(primaryId, secondaryId) {
        try {
            await window.FornecedorService.merge(primaryId, secondaryId);
            UI.alert('Fornecedores mesclados. Pedidos foram atualizados.', 'success');
            await carregarFornecedores();
            await carregarPedidos();
        } catch (error) {
            UI.alert(error.message || 'Erro ao mesclar', 'error');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        UI.renderSelect('filtroStatus', window.APP_CONFIG.catalogs.status);
        UI.renderSelect('filtroArea', window.APP_CONFIG.catalogs.areas);
        UI.renderSelect('filtroLoja', window.APP_CONFIG.catalogs.lojas);

        ['filtroStatus','filtroArea','filtroLoja','filtroFornecedor','filtroFornecedor','filtroDataInicial','filtroDataFinal','filtroBusca']
            .forEach(id => document.getElementById(id).addEventListener('input', aplicarFiltros));

        document.getElementById('btnLogin').addEventListener('click', async () => {
            try {
                const account = await ensureLogin();
                validarGestor(account);
                AppState.user = account;
                document.getElementById('userInfo').textContent = `${account.name || ''} ‚Ä¢ ${account.username}`;
                UI.toggleLoggedIn(true);
                await carregarFornecedores();
                aplicarFiltros();
            } catch (error) { UI.alert(error.message || 'Erro no login', 'error'); }
        });

        document.getElementById('btnFecharModal').addEventListener('click', fecharModal);
        document.getElementById('btnAprovar').addEventListener('click', aprovarPedido);
        document.getElementById('btnRecusar').addEventListener('click', recusarPedido);

        document.getElementById('btnPdfFornecedor').addEventListener('click', () => {
            const fornecedor = prompt('Filtrar por fornecedor (opcional):', AppState.filtros.fornecedor || '');
            const lista = AppState.pedidos.filter(p => !fornecedor || (p.fornecedor_detectado || p.fornecedor_nome_digitado || '').toLowerCase().includes(fornecedor.toLowerCase()));
            PdfService.gerar('Fornecedor', lista);
        });
        document.getElementById('btnPdfLoja').addEventListener('click', () => {
            const loja = prompt('Filtrar por loja/unidade (opcional):', AppState.filtros.loja || '');
            const lista = AppState.pedidos.filter(p => !loja || (p.loja_unidade || '').toLowerCase().includes(loja.toLowerCase()));
            PdfService.gerar('Loja', lista);
        });
    });
</script>
</body>
</html>
